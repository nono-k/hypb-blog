---
title: rehype-pretty-codeã‚’ä½¿ã£ãŸã‚³ãƒ¼ãƒ‰ãƒã‚¤ãƒ©ã‚¤ãƒˆã®å®Ÿè£…æ–¹æ³•
slug: astrojs-rehype-pretty-code
pubDate: '2024-04-29'
image: ../../assets/images/astrojs-rehype-pretty-code.jpg
ogp: 'iamges/ogp/astrojs-rehype-pretty-code.jpg'
category: ãƒ–ãƒ­ã‚°
tags:
  - Astro
  - Markdown
description: Astroã§ã®rehype-pretty-codeã‚’ä½¿ã£ãŸã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ã‚„ã‚Šæ–¹
---

## ã¯ã˜ã‚ã«

Astroã§ä½œæˆã—ãŸã“ã®ãƒ–ãƒ­ã‚°ã®ã‚³ãƒ¼ãƒ‰ãƒã‚¤ãƒ©ã‚¤ãƒˆã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã«rehype-pretty-codeã‚’ä½¿ã£ãŸã®ã§å®Ÿè£…æ–¹æ³•ãªã©ã‚’æ›¸ãğŸ”®ï¼ˆğŸ‘‡ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè©³ã—ãæ›¸ã‹ã‚Œã¦ã„ã‚‹ã®ã§ã“ã¡ã‚‰ã‚’è¦‹ãŸã»ã†ãŒã„ã„ã‹ã‚‚ã§ã™ï¼‰

https://rehype-pretty.pages.dev/

## rehype-pretty-codeã¨ã¯ï¼Ÿ

rehype-pretty-codeã¯åå‰ã®é€šã‚Šrehypeãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã«ãªã‚Šã¾ã™ã€‚
ã“ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã§ã‚‚[Shiki](https://shiki.matsu.io/)ã‚’ä½¿ã£ã¦ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

å‰å›ã®è¨˜äº‹ã§ã‚‚æ›¸ãã¾ã—ãŸãŒã€Astroã§ã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§Shikiã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã«ãªãœrehype-pretty-codeã‚’ä½¿ã£ãŸã‹ã¨ã„ã†ã¨ã€Astroã§ãƒ•ã‚¡ã‚¤ãƒ«åã¨è¡Œã®å¼·èª¿è¡¨ç¾ã®ã‚„ã‚Šæ–¹ãŒåˆ†ã‹ã‚‰ãªã‹ã£ãŸã‹ã‚‰ã§ã™ã€‚

ã“ã®ãƒ–ãƒ­ã‚°ã§ã¯â¬‡ï¸ã®ã‚ˆã†ã«`title`ã¨`{}`ã®ä¸­ã«æ›¸ãã“ã¨ã§ãƒ•ã‚¡ã‚¤ãƒ«åã‚„è¡Œã®å¼·èª¿ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

````
```js title="astro.config.mjs" {3-5, 9-11}
export default defineConfig({
  site: siteUrl,
  prefetch: {
    prefetchAll: true
  },
  vite: {
    css: {
      preprocessorOptions: {
        scss: {
          additionalData: `@use "src/styles/mixin.scss";`
        }
```
````

```js title="astro.config.mjs" {3-5, 9-11}
export default defineConfig({
  site: siteUrl,
  prefetch: {
    prefetchAll: true
  },
  vite: {
    css: {
      preprocessorOptions: {
        scss: {
          additionalData: `@use "src/styles/mixin.scss";`
        }
```

ã“ã®è¨˜äº‹ã§ã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«åã®è¡¨ç¤ºã¨è¡Œã®å¼·èª¿è¡¨ç¾ã¾ã§æ›¸ãã¾ã™ã€‚
è¡Œç•ªå·ã®è¡¨ç¤ºãªã©ã®ã‚„ã‚Šæ–¹ã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¦‹ã¦ãã ã•ã„ã€‚

## Astroã§ä½¿ã†ãŸã‚ã®æº–å‚™

`astro.config.mjs`ã§rehype-pretty-codeã‚’ä½¿ã†æº–å‚™ã‚’ã—ã¾ã™ã€‚
Astroã§ã¯æ¨™æº–ã§ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚¤ãƒ©ã‚¤ãƒˆãŒåŠ¹ã„ã¦ã„ã‚‹ã®ã§`syntaxHighlight`ã‚’`false`ã«ã—ã¾ã™ã€‚
ã¾ãŸã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ†ãƒ¼ãƒã¯`github-dark-dimmed`ãªã®ã§ãƒ†ãƒ¼ãƒã‚’å¤‰ãˆãŸã‚Šã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨€èªã‚’æŒ‡å®šã™ã‚‹éš›ã¯`defaultLang`ã§æŒ‡å®šã§ãã‚‹ã®ã§`codeOptions`ã«æŒ‡å®šã—ã¾ã—ã‚‡ã†ã€‚

Shikiã®ãƒ†ãƒ¼ãƒã¯[ã“ã“](https://shiki.style/themes#themes)ã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚

```js title="astro.config.mjs"
import { defineConfig } from 'astro/config';
import rehypePrettyCode from 'rehype-pretty-code';

const codeOptions = {
  theme: 'one-dark-pro',
  defaultLang: 'plaintext',
}

// https://astro.build/config
export default defineConfig({
  // ...
  markdown: {
    syntaxHighlight: false,
    rehypePlugins: [
      [rehypePrettyCode, codeOptions],
    ]
  }
})
```

## ã‚³ãƒ¼ãƒ‰ã®è¡Œã®å¼·èª¿è¡¨ç¾

è¡Œã®å¼·èª¿è¡¨ç¾æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹ãŸã‚ã«ã€`rehype-pretty-code`ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```js title="astro.config.mjs" {}
const codeOptions = {
  // ...
  onVistitLine(node) {
    if (node.children.length === 0) {
      node.children = [{ type: 'text', value: ' ' }];
    }
  },
  onVisitHighlightedLine(node) {
    if (!node.properties) {
      node.properties = {}; // propertiesãŒå®šç¾©ã•ã‚Œã¦ã„ãªã„å ´åˆã¯åˆæœŸåŒ–ã™ã‚‹
    }
    if (!node.properties.className) {
      node.properties.className = []; // classNameãŒå®šç¾©ã•ã‚Œã¦ã„ãªã„å ´åˆã¯åˆæœŸåŒ–ã™ã‚‹
    }
    node.properties.className.push('highlighted');
  },
};
```

ã“ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ã€è©²å½“éƒ¨åˆ†ã®ã‚¯ãƒ©ã‚¹ã«`highlighted`ãŒä»˜ãã¾ã™ã€‚
è‡ªåˆ†ã®ç’°å¢ƒã ã¨ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸã®ã§`if(!node.properties)`ã¨`if(!node.properties.className)`ã§æ¡ä»¶åˆ†å²ã•ã›ã¦ã¾ã™ã€‚

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯è¡¨ç¤ºãŒå¤‰ã‚ã‚‰ãªã„ã®ã§ãƒã‚¤ãƒ©ã‚¤ãƒˆç”¨ã®ã‚¯ãƒ©ã‚¹ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«è¿½åŠ ã—ã¾ã™ã€‚

```scss title="code.scss"
[data-rehype-pretty-code-figure] {
  position: relative;
  pre {
    border-radius: 0.5rem;
    overflow-x: auto;
  }
  pre > code {
    display: grid;
    border-radius: 0.5rem;
    padding: 1.5rem 0 1.5rem;
    line-height: 1.75;
    font-family: "ui-monospace","SFMono-Regular","SF Mono","Menlo","Monaco","Consolas","monospace";
    [data-line] {
      border-left: 4px solid transparent;
      padding: 0 1.5rem;
    }
    .highlighted {
      background-color: #2e4c35;
      border-color: #469458;
    }
  }
}
```

## ãƒ•ã‚¡ã‚¤ãƒ«åã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°

rehype-pretty-codeã‚’ä½¿ã†ã“ã¨ã§Markdownã«titleã‚’è¨˜å…¥ã™ã‚‹ã¨`<figure data-rehype-pretty-code-figure>`ç›´ä¸‹ã«`<figcaption data-rehype-pretty-code-title>`ã«ãƒ•ã‚¡ã‚¤ãƒ«åãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã“ã¡ã‚‰ã«ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°ã‚’è¿½åŠ ã—ã¾ã™ã€‚

ğŸ‘‡ã¯ã“ã®ãƒ–ãƒ­ã‚°ã§ã®ãƒ•ã‚¡ã‚¤ãƒ«åã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°ã«ãªã‚Šã¾ã™ã€‚

```scss title="code.scss" {3-15}
[data-rehype-pretty-code-figure] {
  position: relative;
  [data-rehype-pretty-code-title] {
    position: absolute;
    top: 0;
    left: 0;
    padding: 0.5rem 1rem;
    background-color: var(--yellow);
    border-top-left-radius: 0.5rem;
    font-size: 0.75rem;
    line-height: 1;
    & + pre > code {
      padding-top: 2.5rem;
    }
  }
  // ...
}
```

ã“ã“ã§ãƒ•ã‚¡ã‚¤ãƒ«åãŒç„¡ã„å ´åˆã«ä¸Šã®ä½™ç™½ãŒç©ºã„ã¦ã—ã¾ã†ã®ã§`& + pre > code`ã§`padding-top`ã‚’ä¸Šæ›¸ãã—ã¦ã¾ã™ã€‚

## ã¾ã¨ã‚

Astroã§ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã«rehype-pretty-codeã‚’ä½¿ã£ãŸå®Ÿè£…æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚
CSSã«ã¤ã„ã¦ã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ç”¨æ„ã•ã‚Œã¦ç„¡ãè‡ªåˆ†ã§ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°ã‚’ã¤ã‘ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€ãã®åˆ†è‡ªç”±ã«ãƒ‡ã‚¶ã‚¤ãƒ³ã§ãã‚‹ã®ã§ã„ã„ã§ã™ã­ã€‚

## å‚è€ƒã‚µã‚¤ãƒˆ

https://kohan.dev/posts/markdown-reader-astro-rehype-pretty-code/